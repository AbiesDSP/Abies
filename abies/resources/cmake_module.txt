# Tests
add_library(test_${module_name} test_${module_name}.cpp)
target_include_directories(test_${module_name} PRIVATE ${VERILATOR_ROOT}/include)
target_link_libraries(test_${module_name} PRIVATE CppUTest CppUTestExt)

# Utility Libraries
target_link_libraries(test_${module_name} PRIVATE testbench)

# Verilog sources
set(V_SRCS "")
list(APPEND V_SRCS "${module_name}.sv")
message(STATUS "Verilating ${module_name} using ${module_name}.sv as top")

# Run verilator
verilate(test_${module_name} TRACE
    TOP_MODULE ${module_name}
    # INCLUDE_DIRS ${CMAKE_SOURCE_DIR}/framework
    SOURCES ${V_SRCS}
    DIRECTORY ${CMAKE_BINARY_DIR}/verilated
    PREFIX V${module_class}
    VERILATOR_ARGS ""
)
# Create trace directories when libraries are built
add_custom_command(TARGET test_${module_name}
    POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E make_directory ${CMAKE_BINARY_DIR}/traces/${module_name}
    COMMENT "Creating trace directory: ${CMAKE_BINARY_DIR}/traces/${module_name}")
